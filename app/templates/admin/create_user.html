{% extends "base.html" %}

{% block title %}Создание пользователя - Bitrix24 Security Audit{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-cyber-primary glow">
                        <i class="fas fa-user-plus"></i> 
                        CREATE NEW USER
                    </h1>
                    <p class="text-muted">Добавление нового пользователя в систему аудита</p>
                </div>
                <div class="hacker-text">
                    <small>
                        > ACCESS LEVEL: <span class="text-cyber-danger">ADMINISTRATOR</span><br>
                        > OPERATION: <span class="text-cyber-warning">USER_CREATION</span><br>
                        > SECURITY: <span class="text-cyber-success">ENCRYPTED</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-terminal"></i> 
                        USER REGISTRATION CONSOLE
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate id="createUserForm" data-autosave="user-creation">
                        <!-- User Identity Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-cyber-accent border-bottom border-cyber pb-2 mb-3">
                                    <i class="fas fa-id-card"></i> IDENTITY INFORMATION
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="hacker-text mb-2">
                                        <small>> ENTER USERNAME:</small>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text bg-cyber-primary text-dark">
                                            <i class="fas fa-user"></i>
                                        </span>
                                        <input type="text" 
                                               class="form-control" 
                                               id="username" 
                                               name="username" 
                                               placeholder="user@audit.system" 
                                               pattern="^[a-zA-Z0-9_]{3,20}$"
                                               required>
                                        <div class="invalid-feedback">
                                            Имя пользователя должно содержать 3-20 символов (буквы, цифры, подчеркивание)
                                        </div>
                                    </div>
                                    <small class="text-muted">Уникальное имя для входа в систему</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="hacker-text mb-2">
                                        <small>> ENTER EMAIL ADDRESS:</small>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text bg-cyber-primary text-dark">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                        <input type="email" 
                                               class="form-control" 
                                               id="email" 
                                               name="email" 
                                               placeholder="user@company.com" 
                                               required>
                                        <div class="invalid-feedback">
                                            Введите корректный email адрес
                                        </div>
                                    </div>
                                    <small class="text-muted">Используется для уведомлений и восстановления доступа</small>
                                </div>
                            </div>
                        </div>

                        <!-- Security Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-cyber-accent border-bottom border-cyber pb-2 mb-3">
                                    <i class="fas fa-shield-alt"></i> SECURITY SETTINGS
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="hacker-text mb-2">
                                        <small>> SET PASSWORD:</small>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text bg-cyber-primary text-dark">
                                            <i class="fas fa-key"></i>
                                        </span>
                                        <input type="password" 
                                               class="form-control" 
                                               id="password" 
                                               name="password" 
                                               placeholder="••••••••••••"
                                               minlength="8"
                                               pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                                               required>
                                        <button type="button" 
                                                class="btn btn-outline-primary" 
                                                onclick="togglePasswordVisibility('password')"
                                                id="togglePasswordBtn">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <div class="invalid-feedback">
                                            Пароль должен содержать минимум 8 символов: заглавные и строчные буквы, цифры, спецсимволы
                                        </div>
                                    </div>
                                    <div class="password-strength mt-2">
                                        <div class="progress" style="height: 4px;">
                                            <div class="progress-bar" id="passwordStrength" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="passwordStrengthText">Введите пароль</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="hacker-text mb-2">
                                        <small>> CONFIRM PASSWORD:</small>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text bg-cyber-primary text-dark">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                        <input type="password" 
                                               class="form-control" 
                                               id="confirmPassword" 
                                               name="confirmPassword" 
                                               placeholder="••••••••••••"
                                               required>
                                        <button type="button" 
                                                class="btn btn-outline-primary" 
                                                onclick="togglePasswordVisibility('confirmPassword')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <div class="invalid-feedback">
                                            Пароли не совпадают
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Access Control Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-cyber-accent border-bottom border-cyber pb-2 mb-3">
                                    <i class="fas fa-users-cog"></i> ACCESS CONTROL
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="hacker-text mb-2">
                                        <small>> SELECT USER ROLE:</small>
                                    </div>
                                    <select class="form-select" id="role" name="role" required>
                                        <option value="">Выберите роль...</option>
                                        <option value="viewer">🔍 Viewer - Только просмотр</option>
                                        <option value="user">👤 User - Управление проектами</option>
                                        <option value="admin">👑 Administrator - Полный доступ</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Выберите роль пользователя
                                    </div>
                                </div>
                                <div id="roleDescription" class="alert alert-info" style="display: none;"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="hacker-text mb-2">
                                        <small>> ACCOUNT STATUS:</small>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="isActive" 
                                               name="is_active" 
                                               checked>
                                        <label class="form-check-label text-cyber-primary" for="isActive">
                                            <i class="fas fa-power-off"></i> Активный пользователь
                                        </label>
                                    </div>
                                    <small class="text-muted">Деактивированные пользователи не могут войти в систему</small>
                                </div>
                            </div>
                        </div>

                        <!-- System Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card bg-tertiary border-cyber">
                                    <div class="card-body">
                                        <h6 class="text-cyber-accent">
                                            <i class="fas fa-info-circle"></i> SYSTEM INFORMATION
                                        </h6>
                                        <div class="hacker-text">
                                            <small>
                                                > USER CREATION TIME: <span class="text-cyber-primary" id="currentTime">Loading...</span><br>
                                                > CREATED BY: <span class="text-cyber-success">{{ current_user.username }}</span><br>
                                                > SECURITY LEVEL: <span class="text-cyber-warning">ENCRYPTED</span><br>
                                                > DATABASE: <span class="text-cyber-accent">SQLITE_SECURE</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <a href="{{ url_for('users') }}" class="btn btn-outline-secondary">
                                            <i class="fas fa-arrow-left"></i> 
                                            Назад к списку
                                        </a>
                                        <button type="button" class="btn btn-outline-warning ms-2" onclick="generatePassword()">
                                            <i class="fas fa-random"></i> 
                                            Генерировать пароль
                                        </button>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary me-2" onclick="previewUser()">
                                            <i class="fas fa-eye"></i> 
                                            Предпросмотр
                                        </button>
                                        <button type="submit" class="btn btn-primary pulse">
                                            <i class="fas fa-user-plus"></i> 
                                            СОЗДАТЬ ПОЛЬЗОВАТЕЛЯ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Preview Modal -->
<div class="modal fade" id="userPreviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-cyber">
            <div class="modal-header border-cyber">
                <h5 class="modal-title text-cyber-primary">
                    <i class="fas fa-eye"></i> 
                    USER PREVIEW
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userPreviewContent">
                <!-- Preview content will be inserted here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Password visibility toggle
function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

// Password strength checker
function checkPasswordStrength(password) {
    let strength = 0;
    let feedback = '';
    
    if (password.length >= 8) strength += 1;
    if (password.match(/[a-z]/)) strength += 1;
    if (password.match(/[A-Z]/)) strength += 1;
    if (password.match(/[0-9]/)) strength += 1;
    if (password.match(/[^a-zA-Z0-9]/)) strength += 1;
    
    const strengthBar = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('passwordStrengthText');
    
    switch (strength) {
        case 0:
        case 1:
            strengthBar.style.width = '20%';
            strengthBar.className = 'progress-bar bg-danger';
            feedback = 'Очень слабый пароль';
            break;
        case 2:
            strengthBar.style.width = '40%';
            strengthBar.className = 'progress-bar bg-warning';
            feedback = 'Слабый пароль';
            break;
        case 3:
            strengthBar.style.width = '60%';
            strengthBar.className = 'progress-bar bg-info';
            feedback = 'Средний пароль';
            break;
        case 4:
            strengthBar.style.width = '80%';
            strengthBar.className = 'progress-bar bg-primary';
            feedback = 'Хороший пароль';
            break;
        case 5:
            strengthBar.style.width = '100%';
            strengthBar.className = 'progress-bar bg-success';
            feedback = 'Отличный пароль';
            break;
    }
    
    strengthText.textContent = feedback;
    return strength;
}

// Generate secure password
function generatePassword() {
    const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@$!%*?&';
    let password = '';
    
    // Ensure at least one character from each required category
    const categories = [
        'abcdefghijklmnopqrstuvwxyz',     // lowercase
        'ABCDEFGHIJKLMNOPQRSTUVWXYZ',     // uppercase
        '0123456789',                     // digits
        '@$!%*?&'                        // special characters
    ];
    
    // Add one character from each category
    categories.forEach(category => {
        password += category[Math.floor(Math.random() * category.length)];
    });
    
    // Fill the rest randomly
    for (let i = password.length; i < 12; i++) {
        password += charset[Math.floor(Math.random() * charset.length)];
    }
    
    // Shuffle the password
    password = password.split('').sort(() => Math.random() - 0.5).join('');
    
    document.getElementById('password').value = password;
    document.getElementById('confirmPassword').value = password;
    
    checkPasswordStrength(password);
    AKUMA.showNotification('Пароль сгенерирован успешно!', 'success');
}

// Role description updater
function updateRoleDescription() {
    const role = document.getElementById('role').value;
    const descriptionDiv = document.getElementById('roleDescription');
    
    const descriptions = {
        viewer: {
            text: 'Наблюдатель может только просматривать результаты сканирования и отчеты. Не имеет права создавать проекты или изменять настройки.',
            class: 'alert-info'
        },
        user: {
            text: 'Пользователь может создавать проекты, запускать сканирования и загружать отчеты. Имеет доступ только к своим проектам.',
            class: 'alert-primary'
        },
        admin: {
            text: 'Администратор имеет полный доступ ко всем функциям системы: управление пользователями, все проекты, системные настройки.',
            class: 'alert-warning'
        }
    };
    
    if (role && descriptions[role]) {
        descriptionDiv.innerHTML = `
            <strong>Права доступа:</strong><br>
            ${descriptions[role].text}
        `;
        descriptionDiv.className = `alert ${descriptions[role].class}`;
        descriptionDiv.style.display = 'block';
    } else {
        descriptionDiv.style.display = 'none';
    }
}

// Preview user function
function previewUser() {
    const formData = new FormData(document.getElementById('createUserForm'));
    const userData = {};
    
    for (let [key, value] of formData.entries()) {
        userData[key] = value;
    }
    
    const preview = `
        <div class="hacker-text">
            <div class="row">
                <div class="col-6">
                    <strong class="text-cyber-primary">Username:</strong><br>
                    <span class="text-cyber-accent">${userData.username || 'Not set'}</span>
                </div>
                <div class="col-6">
                    <strong class="text-cyber-primary">Email:</strong><br>
                    <span class="text-cyber-accent">${userData.email || 'Not set'}</span>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-6">
                    <strong class="text-cyber-primary">Role:</strong><br>
                    <span class="badge bg-${userData.role === 'admin' ? 'danger' : userData.role === 'user' ? 'primary' : 'secondary'}">
                        ${userData.role ? userData.role.toUpperCase() : 'Not selected'}
                    </span>
                </div>
                <div class="col-6">
                    <strong class="text-cyber-primary">Status:</strong><br>
                    <span class="badge bg-${userData.is_active ? 'success' : 'warning'}">
                        ${userData.is_active ? 'ACTIVE' : 'INACTIVE'}
                    </span>
                </div>
            </div>
            <div class="mt-3">
                <strong class="text-cyber-primary">Password Security:</strong><br>
                <div class="progress mt-1" style="height: 4px;">
                    <div class="progress-bar bg-${checkPasswordStrength(userData.password || '') > 3 ? 'success' : 'warning'}" 
                         style="width: ${checkPasswordStrength(userData.password || '') * 20}%"></div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('userPreviewContent').innerHTML = preview;
    const modal = new bootstrap.Modal(document.getElementById('userPreviewModal'));
    modal.show();
}

// Form validation
function validateForm() {
    const form = document.getElementById('createUserForm');
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    let isValid = true;
    
    // Check if passwords match
    if (password !== confirmPassword) {
        document.getElementById('confirmPassword').setCustomValidity('Пароли не совпадают');
        isValid = false;
    } else {
        document.getElementById('confirmPassword').setCustomValidity('');
    }
    
    // Check password strength
    if (checkPasswordStrength(password) < 3) {
        document.getElementById('password').setCustomValidity('Пароль слишком слабый');
        isValid = false;
    } else {
        document.getElementById('password').setCustomValidity('');
    }
    
    return isValid;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Update current time
    function updateCurrentTime() {
        document.getElementById('currentTime').textContent = new Date().toLocaleString('ru-RU');
    }
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    
    // Password strength checker
    document.getElementById('password').addEventListener('input', function() {
        checkPasswordStrength(this.value);
        validateForm();
    });
    
    // Confirm password checker
    document.getElementById('confirmPassword').addEventListener('input', validateForm);
    
    // Role description updater
    document.getElementById('role').addEventListener('change', updateRoleDescription);
    
    // Form submission with validation
    document.getElementById('createUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateForm() && this.checkValidity()) {
            AKUMA.showConfirmDialog(
                'Создать нового пользователя с указанными параметрами?',
                () => {
                    this.submit();
                }
            );
        } else {
            this.classList.add('was-validated');
            AKUMA.showNotification('Проверьте правильность заполнения всех полей', 'warning');
        }
    });
    
    // Username availability checker (simulated)
    document.getElementById('username').addEventListener('blur', function() {
        if (this.value) {
            // Simulate username availability check
            setTimeout(() => {
                const isAvailable = Math.random() > 0.3; // 70% chance of being available
                if (!isAvailable) {
                    this.setCustomValidity('Имя пользователя уже занято');
                    this.classList.add('is-invalid');
                } else {
                    this.setCustomValidity('');
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
            }, 500);
        }
    });
});
</script>
{% endblock %}
