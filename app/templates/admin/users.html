{% extends "base.html" %}

{% block title %}Управление пользователями - Bitrix24 Security Audit{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-cyber-primary glow">
                        <i class="fas fa-users-cog"></i> 
                        USER MANAGEMENT CONSOLE
                    </h1>
                    <p class="text-muted">Управление пользователями и правами доступа</p>
                </div>
                <div class="hacker-text">
                    <small>
                        > ACCESS LEVEL: <span class="text-cyber-danger">ADMINISTRATOR</span><br>
                        > TOTAL USERS: <span class="text-cyber-primary">{{ users|length }}</span><br>
                        > ACTIVE SESSIONS: <span class="text-cyber-success">MONITORING</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-terminal"></i> 
                            ADMIN ACTIONS
                        </h5>
                        <a href="{{ url_for('create_user') }}" class="btn btn-primary pulse">
                            <i class="fas fa-user-plus"></i> 
                            ADD NEW USER
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-cyber-primary text-dark">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       class="form-control" 
                                       id="userSearch" 
                                       placeholder="Поиск пользователей..."
                                       onkeyup="filterUsers()">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2">
                                <select class="form-select" id="roleFilter" onchange="filterByRole()">
                                    <option value="">Все роли</option>
                                    <option value="admin">Администраторы</option>
                                    <option value="user">Пользователи</option>
                                    <option value="viewer">Наблюдатели</option>
                                </select>
                                <button class="btn btn-outline-primary" onclick="exportUsers()" data-bs-toggle="tooltip" title="Экспорт пользователей">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-database"></i> 
                        USER DATABASE
                    </h5>
                </div>
                <div class="card-body">
                    {% if users %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th data-sort="username">
                                        <i class="fas fa-user"></i> 
                                        Пользователь
                                        <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th data-sort="email">
                                        <i class="fas fa-envelope"></i> 
                                        Email
                                        <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th data-sort="role">
                                        <i class="fas fa-shield-alt"></i> 
                                        Роль
                                        <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th data-sort="status">
                                        <i class="fas fa-power-off"></i> 
                                        Статус
                                        <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th data-sort="created">
                                        <i class="fas fa-calendar-plus"></i> 
                                        Создан
                                        <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th data-sort="login">
                                        <i class="fas fa-clock"></i> 
                                        Последний вход
                                        <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th>
                                        <i class="fas fa-cogs"></i> 
                                        Действия
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr data-user-role="{{ user.role }}" data-user-status="{{ 'active' if user.is_active else 'inactive' }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-2">
                                                <i class="fas fa-user-circle fa-2x text-cyber-primary"></i>
                                            </div>
                                            <div>
                                                <strong class="text-cyber-primary">{{ user.username }}</strong>
                                                {% if user.id == current_user.id %}
                                                <span class="badge bg-info ms-1">YOU</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-cyber-accent">{{ user.email }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if user.role == 'admin' %}danger{% elif user.role == 'user' %}primary{% else %}secondary{% endif %}">
                                            <i class="fas fa-{% if user.role == 'admin' %}crown{% elif user.role == 'user' %}user{% else %}eye{% endif %}"></i>
                                            {{ user.role.upper() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if user.is_active %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle"></i> ACTIVE
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-pause-circle"></i> INACTIVE
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ user.created_at.strftime('%d.%m.%Y') if user.created_at else 'N/A' }}
                                        </small>
                                    </td>
                                    <td>
                                        <small class="text-{% if user.last_login %}cyber-success{% else %}muted{% endif %}">
                                            {{ user.last_login.strftime('%d.%m.%Y %H:%M') if user.last_login else 'Никогда' }}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-primary dropdown-toggle" 
                                                    data-bs-toggle="dropdown">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                            <ul class="dropdown-menu bg-dark border-cyber">
                                                {% if user.id != current_user.id %}
                                                <li>
                                                    <a class="dropdown-item text-light" 
                                                       href="#" 
                                                       onclick="editUser({{ user.id }})">
                                                        <i class="fas fa-edit"></i> Редактировать
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item text-light" 
                                                       href="#" 
                                                       onclick="manageProjects({{ user.id }})">
                                                        <i class="fas fa-project-diagram"></i> Управление проектами
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item text-light" 
                                                       href="#" 
                                                       onclick="toggleUserStatus({{ user.id }}, {{ user.is_active|lower }})">
                                                        <i class="fas fa-{% if user.is_active %}pause{% else %}play{% endif %}"></i> 
                                                        {% if user.is_active %}Деактивировать{% else %}Активировать{% endif %}
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider border-cyber"></li>
                                                <li>
                                                    <a class="dropdown-item text-danger" 
                                                       href="#" 
                                                       onclick="deleteUser({{ user.id }}, '{{ user.username }}')"
                                                       data-confirm="Удалить пользователя {{ user.username }}?">
                                                        <i class="fas fa-trash"></i> Удалить
                                                    </a>
                                                </li>
                                                {% else %}
                                                <li>
                                                    <span class="dropdown-item-text text-muted">
                                                        <i class="fas fa-info-circle"></i> 
                                                        Это ваш аккаунт
                                                    </span>
                                                </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">Пользователи не найдены</h4>
                        <p class="text-muted">Создайте первого пользователя системы</p>
                        <a href="{{ url_for('create_user') }}" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Добавить пользователя
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Stats Modal -->
<div class="modal fade" id="userStatsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-cyber">
            <div class="modal-header border-cyber">
                <h5 class="modal-title text-cyber-primary">
                    <i class="fas fa-chart-bar"></i> 
                    USER STATISTICS
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="userRoleChart" width="300" height="300"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="userActivityChart" width="300" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// User management functions
function filterUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const table = document.getElementById('usersTable');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function filterByRole() {
    const roleFilter = document.getElementById('roleFilter').value;
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const userRole = row.getAttribute('data-user-role');
        if (!roleFilter || userRole === roleFilter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function editUser(userId) {
    // Create edit user modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content bg-dark border-cyber">
                <div class="modal-header border-cyber">
                    <h5 class="modal-title text-cyber-primary">
                        <i class="fas fa-user-edit"></i> 
                        EDIT USER
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" name="role" required>
                                <option value="viewer">Viewer</option>
                                <option value="user">User</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="is_active">
                                <label class="form-check-label">Active User</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-cyber">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveUserChanges(${userId})">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
    
    bsModal.show();
}

function manageProjects(userId) {
    AKUMA.showNotification('Функция управления проектами пользователя будет доступна в следующей версии', 'info');
}

function toggleUserStatus(userId, isActive) {
    const action = isActive ? 'деактивировать' : 'активировать';
    AKUMA.showConfirmDialog(`Вы уверены, что хотите ${action} пользователя?`, () => {
        // TODO: Implement user status toggle
        AKUMA.showNotification(`Пользователь успешно ${isActive ? 'деактивирован' : 'активирован'}`, 'success');
        setTimeout(() => window.location.reload(), 1000);
    });
}

function deleteUser(userId, username) {
    AKUMA.showConfirmDialog(
        `ВНИМАНИЕ! Это действие нельзя отменить.<br>Удалить пользователя <strong>${username}</strong>?`,
        () => {
            // TODO: Implement user deletion
            AKUMA.showNotification(`Пользователь ${username} удалён из системы`, 'success');
            setTimeout(() => window.location.reload(), 1000);
        }
    );
}

function exportUsers() {
    const users = [];
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            const cells = row.querySelectorAll('td');
            users.push({
                username: cells[0].textContent.trim(),
                email: cells[1].textContent.trim(),
                role: cells[2].textContent.trim(),
                status: cells[3].textContent.trim(),
                created: cells[4].textContent.trim(),
                lastLogin: cells[5].textContent.trim()
            });
        }
    });
    
    const csv = [
        ['Username', 'Email', 'Role', 'Status', 'Created', 'Last Login'],
        ...users.map(user => Object.values(user))
    ].map(row => row.join(',')).join('\\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    AKUMA.showNotification('Список пользователей экспортирован', 'success');
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Add user statistics button to action bar
    const actionBar = document.querySelector('.card-header .d-flex');
    const statsButton = document.createElement('button');
    statsButton.className = 'btn btn-outline-primary me-2';
    statsButton.innerHTML = '<i class="fas fa-chart-bar"></i> Statistics';
    statsButton.onclick = showUserStats;
    actionBar.insertBefore(statsButton, actionBar.lastElementChild);
    
    // Initialize tooltips
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));
});

function showUserStats() {
    const modal = new bootstrap.Modal(document.getElementById('userStatsModal'));
    modal.show();
    
    // Create role distribution chart
    const roleData = {
        admin: {{ users | selectattr('role', 'equalto', 'admin') | list | length }},
        user: {{ users | selectattr('role', 'equalto', 'user') | list | length }},
        viewer: {{ users | selectattr('role', 'equalto', 'viewer') | list | length }}
    };
    
    AKUMA.createVulnerabilityChart('userRoleChart', roleData);
    
    // Create activity chart
    const activityData = {
        active: {{ users | selectattr('is_active', 'equalto', true) | list | length }},
        inactive: {{ users | selectattr('is_active', 'equalto', false) | list | length }}
    };
    
    AKUMA.createVulnerabilityChart('userActivityChart', activityData);
}
</script>
{% endblock %}
