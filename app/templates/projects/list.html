{% extends "base.html" %}

{% block title %}Проекты - Bitrix24 Security Audit{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="text-cyber-primary glow"><i class="fas fa-project-diagram"></i> PROJECTS</h1>
      <p class="text-muted">Список проектов, их состояние и быстрые действия</p>
    </div>
    <div>
      <a href="{{ url_for('create_project') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Новый проект
      </a>
    </div>
  </div>

  {% if projects %}
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-list"></i> Все проекты</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-dark table-hover" id="projectsTable">
          <thead>
            <tr>
              <th><i class="fas fa-tag"></i> Название</th>
              <th><i class="fas fa-link"></i> URL</th>
              <th><i class="fas fa-signal"></i> Уязвимости</th>
              <th><i class="fas fa-shield-alt"></i> Статус</th>
              <th><i class="fas fa-clock"></i> Обновлено</th>
              <th><i class="fas fa-cogs"></i> Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for p in projects %}
            {% set stats = p.get_vulnerability_stats() %}
            <tr>
              <td>
                <strong class="text-cyber-primary">{{ p.name }}</strong><br>
                <small class="text-muted">Создан: {{ p.created_at.strftime('%d.%m.%Y') }}</small>
              </td>
              <td>
                <a class="text-cyber-accent" href="{{ p.url }}" target="_blank">{{ p.url }}</a>
              </td>
              <td>
                <span class="badge bg-danger">C: {{ stats.critical }}</span>
                <span class="badge bg-warning text-dark">H: {{ stats.high }}</span>
                <span class="badge bg-primary">M: {{ stats.medium }}</span>
                <span class="badge bg-success text-dark">L: {{ stats.low }}</span>
              </td>
              <td>
                <span class="badge bg-{% if p.status=='active' %}success{% elif p.status=='archived' %}secondary{% else %}warning{% endif %}">{{ p.status|upper }}</span>
              </td>
              <td>
                <small class="text-muted">{{ (p.updated_at or p.created_at).strftime('%d.%m.%Y %H:%M') }}</small>
              </td>
              <td>
                <a href="{{ url_for('project_detail', project_id=p.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Открыть">
                  <i class="fas fa-eye"></i>
                </a>
                {% if current_user.is_admin() %}
                <button class="btn btn-sm btn-outline-danger ms-1" 
                        onclick="deleteProject({{ p.id }}, '{{ p.name }}')"
                        data-bs-toggle="tooltip" 
                        title="Удалить проект">
                  <i class="fas fa-trash"></i>
                </button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
  <div class="text-center py-5">
    <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
    <h4 class="text-muted">У вас пока нет проектов</h4>
    <p class="text-muted">Создайте первый проект, чтобы начать аудит безопасности</p>
    <a href="{{ url_for('create_project') }}" class="btn btn-primary">
      <i class="fas fa-plus"></i> Создать проект
    </a>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function deleteProject(projectId, projectName) {
    AKUMA.showConfirmDialog(
        `ВНИМАНИЕ! Это действие нельзя отменить.<br>Удалятся все сканирования и отчеты.<br><strong>Удалить проект "${projectName}"?</strong>`,
        () => {
            fetch(`/projects/${projectId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    AKUMA.showNotification(data.message, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    AKUMA.showNotification(data.error, 'error');
                }
            })
            .catch(error => {
                AKUMA.showNotification('Ошибка при удалении проекта', 'error');
            });
        }
    );
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));
});
</script>
{% endblock %}
